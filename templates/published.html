<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯è§†åŒ–å¤§å±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
        }
        
        html {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        #dashboard-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            color: #fff;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-message {
            text-align: center;
            padding: 60px 20px;
            color: #ff4444;
        }
        
        .error-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .error-title {
            font-size: 1.5rem;
            margin-bottom: 12px;
        }
        
        .error-detail {
            font-size: 1rem;
            opacity: 0.8;
            margin-bottom: 24px;
        }
        
        .back-button {
            display: inline-block;
            padding: 12px 24px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .back-button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        
        /* éšè—æ»šåŠ¨æ¡ä½†ä¿æŒæ»šåŠ¨åŠŸèƒ½ */
        ::-webkit-scrollbar {
            display: none;
        }
        
        html {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body>
    <div id="dashboard-container">
        <div class="loading">
            <div class="spinner"></div>
            <div>æ­£åœ¨åŠ è½½å¯è§†åŒ–å¤§å±...</div>
        </div>
    </div>

    <!-- å¼•å…¥ä¾èµ– -->
    <script src="/static/js/echarts.js"></script>
    <script src="/static/js/echarts-gl-master/dist/echarts-gl.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="/static/js/core/ComponentRegistry.js"></script>
    <script src="/static/js/core/CanvasRenderer.js"></script>
    
    <script>
        /**
         * å‘å¸ƒé¡µé¢æ¸²æŸ“å™¨
         * æŒ‰ç…§éœ€æ±‚æ–‡æ¡£20.2ç« èŠ‚è®¾è®¡
         */
        class PublishedPageRenderer {
            constructor() {
                this.container = document.getElementById('dashboard-container');
                this.pageConfig = null;
                this.canvasRenderer = null;
                this.refreshTimers = new Map();
                this.apiDataListeners = new Map();
                this.websocket = null;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                
                console.log('ğŸ“º PublishedPageRenderer åˆå§‹åŒ–');
                this.init();
            }
            
            async init() {
                try {
                    // è·å–é¡µé¢ID
                    const pageId = this.getPageIdFromUrl();
                    if (!pageId) {
                        throw new Error('é¡µé¢IDæœªæ‰¾åˆ°');
                    }
                    
                    console.log('ğŸ“– åŠ è½½å‘å¸ƒé¡µé¢:', pageId);
                    
                    // ç­‰å¾…ComponentRegistryåˆå§‹åŒ–
                    if (!window.ComponentRegistry) {
                        await this.waitForComponentRegistry();
                    }
                    
                    // åŠ è½½é¡µé¢é…ç½®
                    await this.loadPageConfig(pageId);
                    
                    // æ¸²æŸ“é¡µé¢
                    await this.renderPage();
                    
                    // å¯åŠ¨æ•°æ®åˆ·æ–°
                    this.startDataRefresh();
                    
                    // å¯åŠ¨APIæ•°æ®ç›‘å¬
                    this.startApiDataListener();
                    
                    // å¯åŠ¨WebSocketè¿æ¥ï¼ˆå¦‚æœæ”¯æŒï¼‰
                    this.initWebSocket();
                    
                    console.log('âœ… å‘å¸ƒé¡µé¢åŠ è½½å®Œæˆ');
                    
                } catch (error) {
                    console.error('âŒ å‘å¸ƒé¡µé¢åŠ è½½å¤±è´¥:', error);
                    this.showError(error.message);
                }
            }
            
            async waitForComponentRegistry() {
                return new Promise((resolve) => {
                    const checkRegistry = () => {
                        if (window.ComponentRegistry) {
                            resolve();
                        } else {
                            setTimeout(checkRegistry, 100);
                        }
                    };
                    checkRegistry();
                });
            }
            
            getPageIdFromUrl() {
                const path = window.location.pathname;
                const match = path.match(/\/published\/([\w-]+)/);
                return match ? match[1] : null;
            }
            
            async loadPageConfig(pageId) {
                try {
                    const response = await fetch(`/api/pages/${pageId}`);
                    if (!response.ok) {
                        if (response.status === 404) {
                            throw new Error('é¡µé¢ä¸å­˜åœ¨æˆ–æœªå‘å¸ƒ');
                        }
                        throw new Error(`é¡µé¢åŠ è½½å¤±è´¥ (${response.status})`);
                    }
                    
                    this.pageConfig = await response.json();
                    
                    // æ£€æŸ¥æ˜¯å¦å·²å‘å¸ƒ
                    if (!this.pageConfig.published) {
                        throw new Error('é¡µé¢æœªå‘å¸ƒ');
                    }
                    
                    // æ›´æ–°é¡µé¢æ ‡é¢˜
                    document.title = this.pageConfig.name || 'å¯è§†åŒ–å¤§å±';
                    
                } catch (error) {
                    console.error('é¡µé¢é…ç½®åŠ è½½å¤±è´¥:', error);
                    throw error;
                }
            }
            
            async renderPage() {
                if (!this.pageConfig) {
                    throw new Error('é¡µé¢é…ç½®æœªåŠ è½½');
                }
                
                console.log('ğŸ¨ å¼€å§‹æ¸²æŸ“å‘å¸ƒé¡µé¢');
                
                // æ¸…ç©ºå®¹å™¨
                this.container.innerHTML = '';
                
                // åˆ›å»ºç”»å¸ƒå®¹å™¨ - ä½¿ç”¨çª—å£å°ºå¯¸
                const canvas = document.createElement('div');
                canvas.id = 'published-canvas';
                canvas.style.cssText = `
                    width: 100vw;
                    height: 100vh;
                    background-color: ${this.pageConfig.canvas.backgroundColor || '#000'};
                    position: relative;
                    margin: 0;
                    overflow: hidden;
                    border: none;
                    outline: none;
                `;
                
                // è®¾ç½®èƒŒæ™¯å›¾ç‰‡
                if (this.pageConfig.canvas.backgroundImage) {
                    canvas.style.backgroundImage = `url(${this.pageConfig.canvas.backgroundImage})`;
                    canvas.style.backgroundSize = 'cover';
                    canvas.style.backgroundPosition = 'center';
                    canvas.style.backgroundRepeat = 'no-repeat';
                }
                
                this.container.appendChild(canvas);
                
                // åˆå§‹åŒ–ç”»å¸ƒæ¸²æŸ“å™¨
                this.canvasRenderer = new CanvasRenderer(canvas);
                
                // æ¸²æŸ“é¡µé¢å†…å®¹
                await this.canvasRenderer.renderPage(this.pageConfig);
                
                // é€‚åº”å±å¹•å°ºå¯¸
                this.adaptToScreen();
                
                // è‡ªåŠ¨è¿›å…¥å…¨å±æ¨¡å¼ï¼ˆå¦‚æœæ”¯æŒï¼‰
                this.enterFullscreen();
                
                console.log('âœ… é¡µé¢æ¸²æŸ“å®Œæˆ');
            }
            
            adaptToScreen() {
                const canvas = document.getElementById('published-canvas');
                if (!canvas) return;
                
                const windowWidth = window.innerWidth;
                const windowHeight = window.innerHeight;
                
                // ç”»å¸ƒå·²ç»æ˜¯å…¨å±å°ºå¯¸ï¼Œåªéœ€è¦ç¡®ä¿å®¹å™¨å æ»¡å…¨å±
                this.container.style.width = '100vw';
                this.container.style.height = '100vh';
                this.container.style.display = 'flex';
                this.container.style.alignItems = 'center';
                this.container.style.justifyContent = 'center';
                this.container.style.overflow = 'hidden';
                
                // ç¡®ä¿ç”»å¸ƒå æ»¡å…¨å±
                canvas.style.width = '100vw';
                canvas.style.height = '100vh';
                canvas.style.transform = 'none';
                canvas.style.transformOrigin = 'center center';
                
                console.log('ğŸ“ ç”»å¸ƒå°ºå¯¸å·²è®¾ç½®ä¸ºçª—å£å°ºå¯¸:', windowWidth, 'x', windowHeight);
            }
            
            /**
             * è¿›å…¥å…¨å±æ¨¡å¼
             */
            enterFullscreen() {
                try {
                    // æ£€æŸ¥æ˜¯å¦æ”¯æŒå…¨å±API
                    if (document.documentElement.requestFullscreen) {
                        document.documentElement.requestFullscreen().then(() => {
                            console.log('âœ… å·²è¿›å…¥å…¨å±æ¨¡å¼');
                        }).catch(err => {
                            console.log('âš ï¸ æ— æ³•è¿›å…¥å…¨å±æ¨¡å¼:', err);
                        });
                    } else if (document.documentElement.webkitRequestFullscreen) {
                        document.documentElement.webkitRequestFullscreen();
                        console.log('âœ… å·²è¿›å…¥å…¨å±æ¨¡å¼ (webkit)');
                    } else if (document.documentElement.msRequestFullscreen) {
                        document.documentElement.msRequestFullscreen();
                        console.log('âœ… å·²è¿›å…¥å…¨å±æ¨¡å¼ (ms)');
                    } else {
                        console.log('âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒå…¨å±æ¨¡å¼');
                    }
                } catch (error) {
                    console.log('âš ï¸ å…¨å±æ¨¡å¼å¤±è´¥:', error);
                }
            }
            
            startDataRefresh() {
                if (!this.pageConfig.components) return;
                
                console.log('ğŸ”„ å¯åŠ¨æ•°æ®åˆ·æ–°');
                
                this.pageConfig.components.forEach(componentConfig => {
                    const refreshInterval = componentConfig.refreshInterval;
                    if (refreshInterval && refreshInterval > 0) {
                        const intervalMs = refreshInterval * 1000;
                        
                        // ç«‹å³åŠ è½½ä¸€æ¬¡æ•°æ®
                        this.loadComponentData(componentConfig.id);
                        
                        // è®¾ç½®å®šæ—¶åˆ·æ–°
                        const timer = setInterval(() => {
                            this.loadComponentData(componentConfig.id);
                        }, intervalMs);
                        
                        this.refreshTimers.set(componentConfig.id, timer);
                        
                        console.log(`â° ç»„ä»¶ ${componentConfig.id} æ•°æ®åˆ·æ–°é—´éš”: ${refreshInterval}ç§’`);
                    }
                });
            }
            
            async loadComponentData(componentId) {
                try {
                    const response = await fetch(`/api/components/${componentId}/data`);
                    if (!response.ok) {
                        console.warn(`ç»„ä»¶ ${componentId} æ•°æ®åŠ è½½å¤±è´¥:`, response.status);
                        return;
                    }
                    
                    const data = await response.json();
                    
                    // æ›´æ–°ç»„ä»¶æ•°æ®
                    this.updateComponentWithData(componentId, data);
                    
                } catch (error) {
                    console.error(`ç»„ä»¶ ${componentId} æ•°æ®åŠ è½½å¤±è´¥:`, error);
                }
            }
            
            /**
             * ä½¿ç”¨APIæ•°æ®æ›´æ–°ç»„ä»¶
             */
            updateComponentWithData(componentId, apiData) {
                try {
                    const componentInfo = this.canvasRenderer.getComponent(componentId);
                    if (!componentInfo || !componentInfo.instance) {
                        console.warn(`ç»„ä»¶ ${componentId} æœªæ‰¾åˆ°æˆ–å®ä¾‹æ— æ•ˆ`);
                        return false;
                    }
                    
                    // å¦‚æœAPIè¿”å›äº†æ•°æ®ï¼Œä½¿ç”¨APIæ•°æ®æ›´æ–°
                    if (apiData.data) {
                        // æ›´æ–°ç»„ä»¶é…ç½®
                        componentInfo.config.props = {
                            ...componentInfo.config.props,
                            ...apiData.data
                        };
                        
                        // é‡æ–°æ¸²æŸ“ç»„ä»¶
                        if (componentInfo.instance && typeof componentInfo.instance.setOption === 'function') {
                            componentInfo.instance.setOption(apiData.data, true, true);
                            componentInfo.instance.resize();
                            console.log(`âœ… ç»„ä»¶ ${componentId} å·²ä½¿ç”¨APIæ•°æ®æ›´æ–°`);
                            return true;
                        }
                    } else {
                        // ä½¿ç”¨ä¼ ç»Ÿæ–¹å¼æ›´æ–°
                        const component = window.ComponentRegistry.getComponent(componentInfo.type);
                        if (component && component.updateData) {
                            component.updateData(componentInfo.instance, apiData);
                            console.log(`ğŸ”„ ç»„ä»¶ ${componentId} æ•°æ®å·²æ›´æ–°`);
                            return true;
                        }
                    }
                    
                    return false;
                } catch (error) {
                    console.error(`æ›´æ–°ç»„ä»¶ ${componentId} å¤±è´¥:`, error);
                    return false;
                }
            }
            
            /**
             * å¯åŠ¨APIæ•°æ®ç›‘å¬
             */
            startApiDataListener() {
                console.log('ğŸ“¡ å¯åŠ¨APIæ•°æ®ç›‘å¬');
                
                // ä¸ºæ¯ä¸ªç»„ä»¶è®¾ç½®APIæ•°æ®ç›‘å¬
                if (this.pageConfig.components) {
                    this.pageConfig.components.forEach(componentConfig => {
                        if (componentConfig.apiEndpoint) {
                            this.setupApiListener(componentConfig.id, componentConfig.apiEndpoint);
                        }
                    });
                }
            }
            
            /**
             * è®¾ç½®APIç›‘å¬å™¨
             */
            setupApiListener(componentId, apiEndpoint) {
                const listener = {
                    componentId: componentId,
                    apiEndpoint: apiEndpoint,
                    interval: null,
                    lastData: null
                };
                
                // ç«‹å³è·å–ä¸€æ¬¡æ•°æ®
                this.fetchApiData(listener);
                
                // è®¾ç½®å®šæ—¶è·å–æ•°æ®ï¼ˆæ¯5ç§’ï¼‰
                listener.interval = setInterval(() => {
                    this.fetchApiData(listener);
                }, 5000);
                
                this.apiDataListeners.set(componentId, listener);
                console.log(`ğŸ“¡ ç»„ä»¶ ${componentId} APIç›‘å¬å·²å¯åŠ¨: ${apiEndpoint}`);
            }
            
            /**
             * è·å–APIæ•°æ®
             */
            async fetchApiData(listener) {
                try {
                    const response = await fetch(listener.apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            data: {},
                            options: { animation: true }
                        })
                    });
                    
                    if (!response.ok) {
                        console.warn(`APIè¯·æ±‚å¤±è´¥: ${listener.apiEndpoint}`, response.status);
                        return;
                    }
                    
                    const data = await response.json();
                    
                    // æ£€æŸ¥æ•°æ®æ˜¯å¦æœ‰å˜åŒ–
                    const dataString = JSON.stringify(data);
                    if (dataString !== listener.lastData) {
                        listener.lastData = dataString;
                        
                        // æ›´æ–°ç»„ä»¶
                        this.updateComponentWithData(listener.componentId, data);
                    }
                    
                } catch (error) {
                    console.error(`APIæ•°æ®è·å–å¤±è´¥: ${listener.apiEndpoint}`, error);
                }
            }
            
            /**
             * åˆå§‹åŒ–WebSocketè¿æ¥
             */
            initWebSocket() {
                try {
                    // æ£€æŸ¥æ˜¯å¦æ”¯æŒSocketIO
                    if (!window.io) {
                        console.log('âš ï¸ SocketIOæœªåŠ è½½ï¼Œä½¿ç”¨è½®è¯¢æ–¹å¼');
                        return;
                    }
                    
                    // åˆå§‹åŒ–SocketIOè¿æ¥
                    this.websocket = io();
                    
                    this.websocket.on('connect', () => {
                        console.log('ğŸ”Œ SocketIOè¿æ¥å·²å»ºç«‹');
                        this.reconnectAttempts = 0;
                        
                        // å‘é€é¡µé¢IDï¼Œè®¢é˜…æ•°æ®æ›´æ–°
                        this.websocket.emit('subscribe', {
                            pageId: this.getPageIdFromUrl()
                        });
                    });
                    
                    this.websocket.on('connected', (data) => {
                        console.log('âœ… æœåŠ¡å™¨ç¡®è®¤è¿æ¥:', data.message);
                    });
                    
                    this.websocket.on('subscribed', (data) => {
                        console.log('ğŸ“¡ è®¢é˜…æˆåŠŸ:', data.message);
                    });
                    
                    this.websocket.on('data_update', (message) => {
                        console.log('ğŸ“¡ æ”¶åˆ°æ•°æ®æ›´æ–°:', message);
                        this.handleWebSocketMessage(message);
                    });
                    
                    this.websocket.on('page_refresh', (data) => {
                        console.log('ğŸ”„ æ”¶åˆ°é¡µé¢åˆ·æ–°æŒ‡ä»¤:', data);
                        this.refreshPage();
                    });
                    
                    this.websocket.on('disconnect', () => {
                        console.log('ğŸ”Œ SocketIOè¿æ¥å·²æ–­å¼€');
                        this.attemptReconnect();
                    });
                    
                    this.websocket.on('connect_error', (error) => {
                        console.error('SocketIOè¿æ¥é”™è¯¯:', error);
                    });
                    
                } catch (error) {
                    console.error('SocketIOåˆå§‹åŒ–å¤±è´¥:', error);
                }
            }
            
            /**
             * å¤„ç†WebSocketæ¶ˆæ¯
             */
            handleWebSocketMessage(message) {
                console.log('ğŸ“¨ æ”¶åˆ°WebSocketæ¶ˆæ¯:', message);
                
                // å¤„ç†æ•°æ®æ›´æ–°æ¶ˆæ¯
                if (message.component_id && message.data) {
                    console.log(`ğŸ“¡ æ”¶åˆ°ç»„ä»¶ ${message.component_id} æ•°æ®æ›´æ–°`);
                    this.updateComponentWithData(message.component_id, message.data);
                } else if (message.type === 'data_update') {
                    if (message.componentId && message.data) {
                        console.log(`ğŸ“¡ æ”¶åˆ°ç»„ä»¶ ${message.componentId} æ•°æ®æ›´æ–°`);
                        this.updateComponentWithData(message.componentId, message.data);
                    }
                } else if (message.type === 'page_refresh') {
                    console.log('ğŸ”„ æ”¶åˆ°é¡µé¢åˆ·æ–°æŒ‡ä»¤');
                    this.refreshPage();
                } else {
                    console.log('ğŸ“¨ æ”¶åˆ°æœªçŸ¥WebSocketæ¶ˆæ¯:', message);
                }
            }
            
            /**
             * ä½¿ç”¨æ•°æ®æ›´æ–°ç»„ä»¶
             */
            updateComponentWithData(componentId, data) {
                try {
                    console.log(`ğŸ”„ æ›´æ–°ç»„ä»¶ ${componentId} æ•°æ®:`, data);
                    
                    // æŸ¥æ‰¾ç»„ä»¶
                    const componentElement = document.querySelector(`[data-component-id="${componentId}"]`);
                    if (!componentElement) {
                        console.warn(`ç»„ä»¶ ${componentId} æœªæ‰¾åˆ°`);
                        return;
                    }
                    
                    // è·å–EChartså®ä¾‹
                    const echartsInstance = echarts.getInstanceByDom(componentElement);
                    if (!echartsInstance) {
                        console.warn(`ç»„ä»¶ ${componentId} çš„EChartså®ä¾‹æœªæ‰¾åˆ°`);
                        return;
                    }
                    
                    // ç¡®ä¿å®¹å™¨èƒŒæ™¯é€æ˜
                    componentElement.style.backgroundColor = 'transparent';
                    
                    // åˆå¹¶æ•°æ®ï¼Œä¿æŒé€æ˜èƒŒæ™¯å’Œä¸»é¢˜è®¾ç½®
                    const mergedData = {
                        ...data,
                        backgroundColor: 'transparent' // å¼ºåˆ¶è®¾ç½®é€æ˜èƒŒæ™¯
                    };
                    
                    // æ›´æ–°å›¾è¡¨é…ç½®ï¼Œä½¿ç”¨notMerge=falseæ¥åˆå¹¶é…ç½®è€Œä¸æ˜¯å®Œå…¨æ›¿æ¢
                    echartsInstance.setOption(mergedData, false, true);
                    echartsInstance.resize();
                    
                    console.log(`âœ… ç»„ä»¶ ${componentId} æ•°æ®æ›´æ–°æˆåŠŸ`);
                    
                } catch (error) {
                    console.error(`âŒ æ›´æ–°ç»„ä»¶ ${componentId} æ•°æ®å¤±è´¥:`, error);
                }
            }
            
            /**
             * å°è¯•é‡è¿WebSocket
             */
            attemptReconnect() {
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    const delay = Math.pow(2, this.reconnectAttempts) * 1000; // æŒ‡æ•°é€€é¿
                    
                    console.log(`ğŸ”„ ${delay/1000}ç§’åå°è¯•é‡è¿SocketIO (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
                    
                    setTimeout(() => {
                        this.initWebSocket();
                    }, delay);
                } else {
                    console.log('âŒ SocketIOé‡è¿å¤±è´¥ï¼Œä½¿ç”¨è½®è¯¢æ–¹å¼');
                }
            }
            
            /**
             * åˆ·æ–°é¡µé¢
             */
            async refreshPage() {
                try {
                    console.log('ğŸ”„ åˆ·æ–°é¡µé¢æ•°æ®');
                    const pageId = this.getPageIdFromUrl();
                    await this.loadPageConfig(pageId);
                    await this.renderPage();
                    this.startDataRefresh();
                } catch (error) {
                    console.error('é¡µé¢åˆ·æ–°å¤±è´¥:', error);
                }
            }
            
            showError(message) {
                this.container.innerHTML = `
                    <div class="error-message">
                        <div class="error-icon">âš ï¸</div>
                        <div class="error-title">é¡µé¢åŠ è½½å¤±è´¥</div>
                        <div class="error-detail">${message}</div>
                        <a href="/" class="back-button">è¿”å›é¦–é¡µ</a>
                    </div>
                `;
            }
            
            destroy() {
                // æ¸…é™¤æ‰€æœ‰å®šæ—¶å™¨
                this.refreshTimers.forEach(timer => {
                    clearInterval(timer);
                });
                this.refreshTimers.clear();
                
                // æ¸…é™¤APIæ•°æ®ç›‘å¬å™¨
                this.apiDataListeners.forEach(listener => {
                    if (listener.interval) {
                        clearInterval(listener.interval);
                    }
                });
                this.apiDataListeners.clear();
                
                // å…³é—­SocketIOè¿æ¥
                if (this.websocket) {
                    this.websocket.disconnect();
                    this.websocket = null;
                }
                
                // é”€æ¯ç”»å¸ƒæ¸²æŸ“å™¨
                if (this.canvasRenderer) {
                    this.canvasRenderer.clearCanvas();
                }
                
                console.log('ğŸ—‘ï¸ PublishedPageRenderer å·²é”€æ¯');
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        let publishedRenderer;
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                publishedRenderer = new PublishedPageRenderer();
            });
        } else {
            publishedRenderer = new PublishedPageRenderer();
        }
        
        // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°é€‚åº”
        window.addEventListener('resize', () => {
            if (publishedRenderer) {
                publishedRenderer.adaptToScreen();
            }
        });
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', () => {
            if (publishedRenderer) {
                publishedRenderer.destroy();
            }
        });
        
        // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°é€‚åº”å±å¹•
        window.addEventListener('resize', () => {
            if (window.publishedRenderer) {
                window.publishedRenderer.adaptToScreen();
                // é‡æ–°ç¼©æ”¾ç»„ä»¶
                if (window.publishedRenderer.canvasRenderer) {
                    window.publishedRenderer.canvasRenderer.rescaleComponents();
                }
            }
        });
        
        // å…¨å±çŠ¶æ€å˜åŒ–ç›‘å¬
        document.addEventListener('fullscreenchange', () => {
            if (window.publishedRenderer) {
                setTimeout(() => {
                    window.publishedRenderer.adaptToScreen();
                    if (window.publishedRenderer.canvasRenderer) {
                        window.publishedRenderer.canvasRenderer.rescaleComponents();
                    }
                }, 100);
            }
        });
        
        document.addEventListener('webkitfullscreenchange', () => {
            if (window.publishedRenderer) {
                setTimeout(() => {
                    window.publishedRenderer.adaptToScreen();
                    if (window.publishedRenderer.canvasRenderer) {
                        window.publishedRenderer.canvasRenderer.rescaleComponents();
                    }
                }, 100);
            }
        });
        
        document.addEventListener('mozfullscreenchange', () => {
            if (window.publishedRenderer) {
                setTimeout(() => {
                    window.publishedRenderer.adaptToScreen();
                    if (window.publishedRenderer.canvasRenderer) {
                        window.publishedRenderer.canvasRenderer.rescaleComponents();
                    }
                }, 100);
            }
        });
        
        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            // ESCé”®è¿”å›ç®¡ç†é¡µé¢
            if (e.key === 'Escape') {
                if (confirm('ç¡®å®šè¦ç¦»å¼€å½“å‰é¡µé¢å—ï¼Ÿ')) {
                    window.location.href = '/';
                }
            }
            
            // F11é”®åˆ‡æ¢å…¨å±
            if (e.key === 'F11') {
                e.preventDefault();
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                } else {
                    document.documentElement.requestFullscreen();
                }
            }
        });
        
        console.log('ğŸš€ å‘å¸ƒé¡µé¢è„šæœ¬åŠ è½½å®Œæˆ');
        console.log('ğŸ’¡ æŒ‰ESCé”®è¿”å›ç®¡ç†é¡µé¢ï¼ŒæŒ‰F11é”®åˆ‡æ¢å…¨å±');
    </script>
</body>
</html>
